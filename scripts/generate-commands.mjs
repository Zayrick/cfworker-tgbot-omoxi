import { readdir, readFile, writeFile } from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const repoRoot = path.resolve(__dirname, '..');

const commandsRootDir = path.join(repoRoot, 'src', 'commands');
const outputFile = path.join(repoRoot, 'src', 'bot', 'generated', 'commands.generated.ts');

function toIdentifier(fileBaseName) {
	const cleaned = fileBaseName.replace(/[^a-zA-Z0-9_$]+/g, '_');
	const safe = cleaned.match(/^[a-zA-Z_$]/) ? cleaned : `cmd_${cleaned}`;
	return safe;
}

const entries = await readdir(commandsRootDir, { withFileTypes: true });
const commandDirs = entries
	.filter(e => e.isDirectory())
	.map(e => e.name)
	.sort((a, b) => a.localeCompare(b));

const imports = [];
const vars = [];
for (const dirName of commandDirs) {
	const indexPath = path.join(commandsRootDir, dirName, 'index.ts');
	try {
		await readFile(indexPath, 'utf8');
	} catch {
		continue;
	}
	const varName = toIdentifier(dirName);
	imports.push(`import ${varName} from '../../commands/${dirName}';`);
	vars.push(varName);
}

const content = [
	'/* eslint-disable */',
	'// This file is auto-generated by scripts/generate-commands.mjs. Do not edit manually.',
	"import type { BotCommand } from '../core/command';",
	...imports,
	'',
	`export const commands: BotCommand[] = [${vars.join(', ')}];`,
	'',
].join('\n');

let existing = null;
try {
	existing = await readFile(outputFile, 'utf8');
} catch {
	existing = null;
}

if (existing !== content) {
	await writeFile(outputFile, content, 'utf8');
}
